using AutoFixture;
using Shouldly;
using System.Diagnostics.CodeAnalysis;
using Ticket.Application.Queries.TicketPlus.GetCaptchaAnswer;
using Ticket.Application.UnitTests.AutoFixtureSettings;
using Xunit;

namespace Ticket.Application.UnitTests.Queries.TicketPlus;

[ExcludeFromCodeCoverage]
public class GetCaptchaAnswerHandlerTests
{
    [Theory]
    [AutoTestingData]
    public async Task Handle_GetCaptchaAnswerHandler_GiveValidRequest_ShouldReturnCaptchaAnswer(
        IFixture fixture,
        GetCaptchaAnswerHandler sut
        )
    {
        // Arrange
        var request = fixture
            .Build<GetCaptchaAnswerQuery>()
            .With(x => x.Data, "<svg xmlns:xlink=\"http://www.w3.org/1999/xlink\" xmlns=\"http://www.w3.org/2000/svg\" height=\"75\" width=\"213\" viewBox=\"0,0,213,75\"><path d=\"M37.496593 21.605106Q38.379137 23.562052 40.067482 23.907395Q40.604683 24.022509 41.29537 23.830652Q41.103512 29.816602 41.026769 35.72581Q40.988398 41.558275 41.218627 47.544225Q40.950026 47.505854 40.643055 47.505854Q39.069824 47.505854 37.765194 49.347685Q38.45588 42.364076 38.417509 35.45721Q38.340766 28.511972 37.496593 21.605106zM37.343107 50.498829Q38.417509 48.656998 39.49191 48.196541Q39.415167 49.23257 39.415167 50.230229Q40.144225 49.846514 40.950026 49.961629Q42.983715 50.2686 44.211602 52.992975Q43.022086 45.395423 43.022086 37.874613Q43.022086 30.085203 43.866259 22.717879Q42.8686 24.636453 41.717456 25.250397Q41.717456 24.214367 41.794199 23.139965Q40.988398 23.638794 40.220968 23.485309Q37.995423 23.063222 36.997764 20.185361Q38.033794 27.744543 38.110537 35.342095Q38.225651 42.901277 37.343107 50.498829zM88.077861 48.656998Q86.734859 46.930282 85.430229 43.822192L83.319798 38.680414Q81.708195 42.709419 81.094252 44.014049Q79.636136 46.968653 78.024534 48.887227Q77.640819 48.887227 76.873389 49.002342Q76.873389 41.519903 71.002553 35.533953Q69.237465 33.692122 67.203777 32.195634Q69.083979 32.771206 70.964182 33.078178Q77.065247 38.06647 78.523363 44.359393Q79.444278 42.517562 80.633794 39.294358Q81.976796 35.495581 82.552368 34.190951H83.972113Q84.854657 35.917667 86.044173 39.217615Q87.348803 42.862905 88.001118 44.28265Q89.842949 37.951356 95.368442 33.346778Q96.596329 33.270036 99.359075 32.694463Q90.610378 38.718785 89.420863 48.772113L88.768547 48.656998Q88.423204 48.618627 88.077861 48.656998zM93.181267 51.343002Q92.835924 49.769771 92.835924 48.234912Q92.835924 44.973336 94.255669 41.711761Q96.250986 37.145555 100.39511 34.037465Q99.167218 34.306065 97.287016 34.651409Q99.282333 33.001435 100.58696 32.08052L98.054445 32.540977Q96.826558 32.771206 95.483556 32.924692Q90.265035 37.183926 88.30809 42.248961Q87.655775 40.061787 86.274401 35.764182Q85.96743 35.802553 85.698829 35.802553H85.161629Q85.046514 35.495581 84.240713 33.730493H82.168653Q81.209366 36.569983 79.098935 42.248961Q77.755933 38.526928 74.647843 35.226981Q74.379243 35.226981 74.072271 35.188609L73.496699 35.073495Q72.652527 34.267694 70.849067 32.656092Q67.664234 32.003777 65.975889 31.504948Q76.796646 39.025757 76.412931 49.424428Q76.604789 49.424428 76.969318 49.386056Q77.333847 49.347685 77.525704 49.347685Q77.525704 49.194199 77.717562 51.30463L79.674507 51.151144Q82.283768 48.311655 84.547685 42.517562Q86.044173 46.393081 87.924375 49.079085Q88.231347 49.040713 88.499947 49.059899Q88.768547 49.079085 89.037148 49.079085L91.109208 51.151144zM126.0541 25.979455Q125.32504 26.363169 125.17155 27.16897V32.34912Q126.3227 32.34912 128.54824 32.08052Q128.50987 32.502606 128.4715 33.346778V34.613037L126.8599 34.68978Q126.0541 34.766523 125.17155 34.766523Q125.17155 38.987386 125.09481 47.429111Q122.86927 47.505854 121.37278 48.196541Q122.44718 41.980361 122.33206 34.68978Q121.67975 34.651409 120.37512 34.382808Q120.37512 33.38515 120.18326 31.428205Q121.29603 31.927034 122.25532 32.118891Q122.21695 31.466576 121.90998 28.97243Q121.67975 26.90037 121.67975 25.941083Q121.67975 24.252738 123.09949 23.677166Q123.94367 23.331823 128.81684 22.48765Q129.62265 22.334164 130.46682 22.21905Q130.23659 22.986479 130.0831 23.869023L129.77613 25.442254Q129.12382 25.288768 128.62499 25.403882Q127.97267 25.365511 126.0541 25.979455zM131.54122 27.130599Q131.88656 24.905053 132.50051 22.334164Q131.88656 22.679508 130.58193 23.293451L130.96565 21.566735Q129.73776 21.758592 127.24361 22.295793Q126.0541 22.372536 122.83089 23.293451Q121.25766 23.715537 121.25766 25.59574Q121.25766 25.902712 121.33441 26.248055Q121.56463 27.591057 121.67975 28.934058L121.87161 31.620062Q120.49023 31.236347 119.83792 30.775889Q119.95303 31.735176 119.9914 32.771206L120.10652 34.766523Q120.83558 34.958381 121.64138 35.035123V37.145555H122.02509Q121.90998 43.323363 120.91232 48.810484Q121.90998 48.311655 123.09949 48.043055L122.90764 50.115114Q124.1739 49.846514 125.47853 49.808143Q126.70641 49.769771 127.97267 50.038371Q127.1285 45.011708 127.1285 36.992069Q128.24127 36.992069 130.3517 37.068812V35.188609Q130.3517 34.229322 130.39007 33.270036Q129.89125 33.346778 128.81684 33.615379Q128.81684 32.924692 128.93196 31.58169Q128.08779 31.811919 127.28199 31.888662Q127.28199 30.468918 127.3971 29.049173Q127.55059 28.396858 128.08779 28.051514Q129.04707 27.360828 129.87206 27.284085Q130.69705 27.207342 131.54122 27.130599zM169.057 47.889569Q167.1768 47.812826 165.48845 48.388398Q166.02565 44.743107 166.14077 41.596646Q166.25588 38.526928 166.02565 34.843266Q164.60591 34.459551 163.83848 34.075837L163.45476 31.04449Q164.22219 31.696805 165.83379 32.272377Q165.60357 30.123574 165.18148 27.360828Q167.48377 28.051514 169.13374 27.898029L169.01863 32.540977Q170.43837 32.464234 171.78137 31.965405Q171.743 32.886321 171.51277 34.651409Q169.97791 34.996752 168.94188 34.996752V41.481532Q168.98026 45.702394 169.057 47.889569zM172.20346 31.389833Q171.93486 31.504948 171.32092 31.735176L171.70463 28.934058Q170.89883 29.24103 169.47908 29.471259Q169.47908 28.780573 169.63257 27.399199Q169.01863 27.475942 168.44305 27.475942Q166.29425 27.475942 164.64428 26.746884Q165.14311 29.24103 165.41171 31.735176Q164.52916 31.389833 162.9943 30.353803Q163.33965 31.658433 163.56988 34.382808Q164.03033 34.613037 165.21985 35.035123Q165.25822 35.687439 165.29659 37.107183L165.68031 37.145555L165.79542 37.183926Q165.83379 38.411814 165.83379 39.601329Q165.83379 44.589622 165.02799 48.96397Q165.21985 48.848856 167.1768 48.311655Q167.21517 49.002342 167.10005 50.383715Q167.90585 50.306972 168.71165 50.306972Q170.43837 50.306972 172.08835 50.882544Q170.74534 45.126822 170.9372 37.145555L173.3546 36.76184Q173.43135 35.840925 173.50809 34.804895L173.69995 32.771206Q173.12437 33.039807 171.93486 33.500264Q172.24183 32.157263 172.16509 31.811919Q172.12672 31.58169 172.20346 31.389833z\" /></svg>")
            .Create();

        // Act
        var result = await sut.Handle(request, CancellationToken.None);

        // Assert
        result.ShouldNotBeNull();
        result.CaptchaAnswer.ShouldNotBeNullOrEmpty();
    }
}